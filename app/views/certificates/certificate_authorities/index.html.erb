<% content_for(:page_header) do %>
  <div>
    <h1>Certificate Authorities</h1>
  </div>
<% end %>

<div class="alert alert-warning mb-4">
  <div class="d-flex">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <div>
      <p class="my-0">
        <strong>Warning:</strong> These certificates are intended for developers building on top of XIVAuth, not for general users. If you are simply using XIVAuth to log in to applications, you do not need these.
      </p>
      <p class="mb-0 mt-1">
        Do <strong>not</strong> install these CA certificates into a system or browser trust store, as doing so could weaken your computer's security.
      </p>
    </div>
  </div>
</div>

<h3 class="mb-2">Root CA</h3>

<% if lower_environment? %>
  <div class="alert alert-info d-flex">
      <i class="bi bi-info-circle-fill me-2"></i>
      <div>
        The certificate displayed below is only used in production. It is not part of the trust chain in development
        or staging environments.
      </div>
  </div>
<% end %>

<p class="mb-3">
  The XIVAuth Root CA is the root of trust for all certificates issued by XIVAuth. It signs all intermediate CAs used
  by this service, but never issues end-entity certificates directly. The Root CA private key is stored offline across
  two Yubikeys, with encrypted key material stored on an M-Disc <abbr title="It may or may not be buried underground.">in a secure location</abbr>.
</p>

<p>Verify the certificate using the fingerprints below before using it.</p>
<table class="table table-sm table-borderless table-transparent mb-3">
  <tbody>
    <tr>
      <th scope="row" class="text-muted ps-0" style="width: 5rem">MD5</th>
      <td><code>037e 27d1 aba9 eec1 09c1 f415 3a29 de42</code></td>
    </tr>
    <tr>
      <th scope="row" class="text-muted ps-0">SHA1</th>
      <td><code>6ae7 0907 005b c980 d8d9 a372 f07e f1dc 2027 7a37</code></td>
    </tr>
    <tr>
      <th scope="row" class="text-muted ps-0">SHA256</th>
      <td>
        <code>
          8121 ca12 401c 650e 9dbc 46a8 a638 1349<br>
          1955 28d4 1e79 c7be 8e42 146f 67dc 2dad
        </code>
      </td>
    </tr>
  </tbody>
</table>
<div class="btn-toolbar gap-2">
  <%= link_to "https://pki.xivauth.net/rootca/67DC2DAD.crt", class: "btn btn-sm btn-outline-primary" do %>
    <i class="bi bi-download"></i> Download PEM format
  <% end %>
  <%= link_to "https://pki.xivauth.net/rootca/67DC2DAD.cer", class: "btn btn-sm btn-outline-primary" do %>
    <i class="bi bi-download"></i> Download DER format
  <% end %>
</div>

<hr class="mb-4">

<h3 class="mb-3">Issuing CAs</h3>
<p>
  XIVAuth issues end-entity certificates from intermediate CAs, which are signed by XIVAuth's Root CA.
  Intermediate CA certificates are embedded in AIA extensions on all issued certificates, but are also available
  for direct download below.
</p>

<% if @certificate_authorities.empty? %>
  <p class="text-center pt-4 mb-0">No issuing certificate authorities are configured.</p>
  <p class="text-center small text-danger pb-4">XIVAuth will not be able to issue certificates!</p>
<% else %>
  <div class="table-responsive">
    <table class="table table-hover mb-0">
      <thead>
      <tr>
        <th>Name</th>
        <th>Certificate Types</th>
        <th>Expires</th>
        <th>Certificate Fingerprint</th>
        <th></th>
      </tr>
      </thead>
      <tbody>
      <% @certificate_authorities.each do |ca| %>
        <tr class="align-middle">
          <td>
            <code class="me-1"><%= ca.slug %></code>
            <% if ca.revoked? %>
              <span class="badge bg-danger">Revoked</span>
            <% elsif !ca.active? %>
              <span class="badge bg-secondary">Retired</span>
            <% else %>
              <span class="badge bg-success">Active</span>
            <% end %>
          </td>
          <td><%= ca.allowed_certificate_types.map(&:titleize).join(", ") %></td>
          <td><%= ca.expires_at&.strftime("%Y-%m-%d %H:%M") || "-" %></td>
          <td>
            <% hex = ca.certificate_fingerprint.sub(/^\w+:/, "") %>
            <code class="small" title="<%= hex.scan(/../).join(":") %>">
              <%= raw hex.scan(/.{4}/).each_slice(8).map { |g| g.join(" ") }.join("<br>") %>
            </code>
          </td>
          <td class="text-end"><%= render 'ca_download_links', ca: ca %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<p class="text-muted small mt-4">
  <i class="bi bi-robot"></i> Psst! If you're a computer, request this page with
  <span class="font-monospace">Accept: application/json</span>, or add
  <span class="font-monospace">.json</span> to the URL!
</p>
