<% content_for(:page_header) do %>
  <h2>Edit <%= resource_name.to_s.humanize %></h2>
<% end %>

<div class="row g-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <div class="d-flex align-items-center">
          <i class="bi bi-person-circle me-2 text-primary fs-5" aria-hidden="true"></i>
          <h2 class="h5 mb-0">Profile Information</h2>
        </div>
      </div>
      <%= form_for(resource, as: resource_name, url: user_path, html: { method: :put }) do |f| %>
        <div class="card-body">
          <%= render "devise/shared/error_messages", resource: resource %>

          <div class="mb-3">
            <label class="form-label fw-semibold" for="user_id">User ID</label>
            <div class="input-group" data-controller="utilities--copy-code">
              <input type="text" class="form-control font-monospace" id="user_id" value="<%= resource.id %>" readonly
                     data-utilities--copy-code-target="source" onclick="this.select();">
              <button class="btn btn-outline-secondary" type="button" title="Copy" aria-label="Copy application ID"
                      data-action="utilities--copy-code#copy" data-utilities--copy-code-target="button">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <div class="form-text">The persistent identifier for your user. This cannot be changed.</div>
          </div>

          <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
            <div class="alert alert-warning d-flex align-items-center" role="alert">
              <i class="bi bi-info-circle me-2"></i>
              <div>Currently waiting confirmation for: <strong><%= resource.unconfirmed_email %></strong></div>
            </div>
          <% end %>

          <div class="mb-3">
            <%= f.label :email, class: "form-label fw-semibold" %>
            <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
          </div>

          <%= f.fields_for :profile do |pf| %>
            <div class="mb-3">
              <%= pf.label :display_name, class: 'form-label fw-semibold' %>
              <%= pf.text_field :display_name, class: 'form-control', autocomplete: 'nickname' %>
            </div>
          <% end %>

          <% pwd_open = resource.errors[:password].present? || resource.errors[:password_confirmation].present? %>
          <div class="accordion accordion-flush mb-3" id="settingsAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingChangePassword">
                <button class="accordion-button <%= 'collapsed' unless pwd_open %>" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChangePassword" aria-expanded="<%= pwd_open %>" aria-controls="collapseChangePassword">
                  <% if resource.has_password? %>
                    <i class="bi bi-shield-lock me-2"></i> Change password
                  <% else %>
                    <i class="bi bi-shield-lock-fill me-2"></i> Set password
                  <% end %>
                </button>
              </h2>
              <div id="collapseChangePassword" class="accordion-collapse collapse <%= 'show' if pwd_open %>" aria-labelledby="headingChangePassword" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <% unless resource.has_password? %>
                    <p class="text-muted small">
                      Your account is currently <em>passwordless</em>, meaning you need to use OAuth or a Passkey to
                      sign in. If you wish to use a password, you can set one here. You will still be able to sign in
                      with your linked accounts or Passkeys.
                    </p>
                  <% end %>

                  <!-- Password strength controller wrapper -->
                  <div data-controller="devise--password-strength" data-devise--password-strength-min-score-value="<%= User.min_password_score %>">
                    <div class="mb-3">
                      <%= f.label :password, "New password", class: "form-label fw-semibold mb-1" %>
                      <%= f.password_field :password, autocomplete: "new-password", class: "form-control", aria: { describedby: (@minimum_password_length ? "passwordHelp passwordLengthHelp" : "passwordHelp") },
                                           data: { "action": 'input->devise--password-strength#calc', "devise--password-strength-target": 'password' } %>
                      <div class="form-text text-secondary pt-1">
                        <div class="progress password-strength mb-1" role="meter" aria-hidden="true" data-devise--password-strength-target="meter">
                          <div class="progress-bar bg-primary" data-devise--password-strength-target="meterInner"></div>
                        </div>
                        <p class="mb-0 d-none">
                          <strong class="text-secondary" data-devise--password-strength-target="strength">Unknown</strong>
                          -
                          <span data-devise--password-strength-target="crackTime"></span>
                          <abbr title="Calculated at 1000 guesses/second">to crack</abbr>
                        </p>
                        <ul class="list-unstyled mb-0" data-devise--password-strength-target="tips"></ul>
                      </div>
                    </div>

                    <div class="mb-0">
                      <%= f.label :password_confirmation, "Confirm new password", class: "form-label fw-semibold mb-1" %>
                      <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "form-control", aria: { describedby: "passwordConfirmationHelp" },
                                           data: { "action": "input->devise--password-strength#onConfirm", "devise--password-strength-target": 'confirm' } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <% if resource.has_password? %>
            <div class="mb-3">
              <%= f.label :current_password, class: "form-label fw-semibold" %>
              <%= f.password_field :current_password, autocomplete: "current-password", class: "form-control", aria: { describedby: "currentPasswordHelp" } %>
              <div id="currentPasswordHelp" class="form-text">We need your current password to confirm your changes.
              </div>
            </div>
          <% end %>
        </div>
        <div class="card-footer bg-transparent d-flex justify-content-end">
          <%= f.submit "Save Changes", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>

  <%= render partial: "devise/registrations/sections/social_identities", locals: { resource: resource } %>

  <%= render partial: "devise/registrations/sections/mfa_settings", locals: { resource: resource } %>

  <div class="col-md-6">
    <div class="card border border-danger h-100">
      <div class="card-header bg-opacity-10">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-triangle-fill me-2 text-danger fs-5" aria-hidden="true"></i>
          <h2 class="h5 mb-0 text-danger">Danger Zone</h2>
        </div>
      </div>
      <div class="card-body">
        <p class="text-muted">Deleting your account is irreversible. All data associated with your account will be
          removed.</p>
        <%= button_to "Cancel my account", registration_path(resource_name), class: "btn btn-danger",
                      data: { confirm: "Are you sure?", turbo_confirm: "Are you sure?" },
                      method: :delete %>
      </div>
    </div>
  </div>
</div>
