<div class="col-md-6" id="mfa-settings">
  <div class="card h-100">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="bi bi-shield-lock me-2 text-primary fs-5" aria-hidden="true"></i>
        <h3 class="h5 mb-0">Multi-Factor Authentication</h3>
      </div>
      <% if resource.mfa_enabled? %>
        <span class="badge bg-success">MFA Enabled</span>
      <% else %>
        <span class="badge bg-secondary">MFA Disabled</span>
      <% end %>
    </div>
    <div class="card-body">
      <div class="btn-toolbar gap-2 mb-3" role="toolbar">
        <% if resource.has_password? %>
          <% if resource.totp_credential.present? %>
            <%= button_to user_totp_credential_path, class: "btn btn-outline-danger", method: :delete, data: { turbo_stream: "remote_modal" } do %>
              <i class="bi bi-calculator"></i> Remove OTP Code
            <% end %>
          <% else %>
            <%= button_to new_user_totp_credential_path, class: "btn btn-outline-primary", method: :get, data: { turbo_stream: "remote_modal" } do %>
              <i class="bi bi-calculator"></i> Add OTP Code
            <% end %>
          <% end %>
        <% end %>

        <%= button_to new_user_webauthn_credential_path, class: "btn btn-outline-primary", method: :get, data: { turbo_stream: "remote_modal" } do %>
          <i class="bi bi-usb-drive"></i> Add Security Key
        <% end %>
      </div>

      <% if resource.webauthn_credentials.present? %>
        <h5 class="h6">Registered Security Keys</h5>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
            <tr>
              <th scope="col" style="width: 0;"></th>
              <th scope="col">Nickname</th>
              <th scope="col" class="text-end"></th>
            </tr>
            </thead>
            <tbody>
            <% resource.webauthn_credentials.each do |cred| %>
              <tr>
                <td>
                  <% if cred.device_class.present? %>
                    <%= image_tag cred.device_class.icon_dark, style: "width: 2.5rem; height: 2.5rem;", class: "mx-2" %>
                  <% elsif cred.resident_key? %>
                    <i class="bi bi-fingerprint mx-2" style="font-size: 2.5rem"></i>
                  <% else %>
                    <i class="bi bi-usb-drive mx-2" style="font-size: 2.5rem"></i>
                  <% end %>
                </td>
                <td>
                  <div>
                    <%= cred.nickname %>
                    <% if cred.resident_key? %>
                      <span class="badge bg-success"><i class="bi bi-fingerprint"></i> Passkey</span>
                    <% else %>
                      <span class="badge bg-secondary"><i class="bi bi-usb-drive"></i> MFA Only</span>
                    <% end %>
                  </div>
                  <% if cred.device_class.present? %>
                    <div class="small">
                      Type: <%= cred.device_class.name %>
                    </div>
                  <% end %>
                  <div class="small">
                    <% if cred.last_used_at.present? %>
                      Last used:
                      <span data-controller="utilities--hover-dt" data-utilities--hover-dt-ts-value="<%= cred.last_used_at.to_i %>">
                        <%= distance_of_time_in_words_to_now(cred.last_used_at) %> ago
                      </span>
                    <% else %>
                      <span>Last used: never</span>
                    <% end %>
                  </div>
                </td>
                <td class="text-end">
                  <%= button_to user_webauthn_credential_path(cred), method: :delete, class: "btn btn-sm btn-danger" do %>
                    <i class="bi bi-trash" aria-hidden="true"></i>
                    <span class="visually-hidden">Remove security key <%= cred.nickname %></span>
                  <% end %>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="text-muted mb-0">No security keys registered yet.</p>
      <% end %>
    </div>
  </div>
</div>
