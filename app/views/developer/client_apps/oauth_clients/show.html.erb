<% content_for(:page_header) do %>
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1>Edit OAuth Client</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "My Applications", developer_applications_path %></li>
          <li class="breadcrumb-item"><%= link_to @application.name, developer_application_path(@application) %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @oauth_client.name %></li>
        </ol>
      </nav>
    </div>
    <div>
      <div class="btn-toolbar gap-2">
        <%= button_to developer_oauth_client_path(@oauth_client), method: :delete, class: "btn btn-danger",
                      data: { turbo_stream: true } do %>
          <i class="bi bi-trash"></i> Delete Credential
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="row">
  <!-- Left: Client Details -->
  <div class="col-lg-6">
    <%= form_for @oauth_client, url: developer_oauth_client_path(@oauth_client), as: :oauth_client, html: { role: 'form' } do |f| %>
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
          <i class="bi bi-info-circle me-2"></i>
          <h5 class="mb-0">Client Details</h5>
        </div>
        <div class="card-body">
          <% if @oauth_client.errors.any? %>
            <div class="alert alert-danger" role="alert"><%= t('doorkeeper.applications.form.error') %></div>
          <% end %>

          <!-- Name -->
          <div class="mb-3">
            <label class="form-label" for="oauth_client_name">Name</label>
            <div class="input-group">
              <%= f.text_field :name, id: 'oauth_client_name', class: 'form-control', required: true, placeholder: 'My OAuth Credential' %>
            </div>
          </div>

          <!-- Client ID -->
          <div class="mb-3">
            <label class="form-label" for="client_id_value">Client ID</label>
            <div class="input-group" data-controller="utilities--copy-code">
              <input type="text" class="form-control font-monospace" value="<%= @oauth_client.uid %>" id="client_id_value" readonly
                     data-utilities--copy-code-target="source">
              <button class="btn btn-outline-secondary" type="button" title="Copy" aria-label="Copy client ID"
                      data-action="utilities--copy-code#copy" data-utilities--copy-code-target="button">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>

          <!-- Client Secret -->
          <div class="mb-3">
            <label class="form-label" for="client_secret_value">Client Secret</label>
            <% secret = @oauth_client.plaintext_secret || flash[:application_secret].presence %>
            <% if secret.present? %>
              <div class="alert alert-warning py-2 mb-2">
                This secret is shown only once. Store it somewhere safe.
              </div>
            <% end %>

            <div class="input-group mb-2" data-controller="utilities--copy-code">
              <% if secret.present? %>
                <input type="text" class="form-control font-monospace" value="<%= secret %>" id="client_secret_value" readonly
                       data-utilities--copy-code-target="source">
                <button class="btn btn-outline-secondary" type="button" title="Copy" aria-label="Copy client secret"
                        data-action="utilities--copy-code#copy" data-utilities--copy-code-target="button">
                  <i class="bi bi-clipboard"></i>
                </button>
              <% elsif @oauth_client.needs_secret? %>
                <input type="password" class="form-control font-monospace pe-none" value="Hidden for security" id="client_secret_value" readonly
                       aria-label="Client Secret (hidden)">
                <button class="btn btn-outline-secondary" type="button" title="Hidden for security" aria-label="Copy client secret"
                        disabled aria-disabled="true" data-utilities--copy-code-target="button">
                  <i class="bi bi-clipboard"></i>
                </button>
              <% else %>
                <input type="text" class="form-control font-monospace" value="Not required for selected flows" id="client_secret_value" readonly
                       aria-label="Client Secret (not required)">
                <button class="btn btn-outline-secondary" type="button" title="Not required" aria-label="Copy client secret"
                        disabled aria-disabled="true" data-utilities--copy-code-target="button">
                  <i class="bi bi-clipboard"></i>
                </button>
              <% end %>
            </div>

            <% if @oauth_client.needs_secret? %>
              <%= button_tag type: :submit, name: :regenerate_secret, value: 1, class: 'btn btn-outline-primary btn-sm' do %>
                <i class="bi bi-arrow-clockwise"></i> Regenerate Secret
              <% end %>
            <% end %>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <%= f.submit t('doorkeeper.applications.buttons.submit'), class: 'btn btn-primary' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Right: Redirect URIs -->
  <div class="col-lg-6">
    <%= form_for @oauth_client, url: developer_oauth_client_path(@oauth_client), as: :oauth_client, html: { role: 'form' } do |f| %>
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
          <i class="bi bi-link-45deg me-2"></i>
          <h5 class="mb-0">Redirect URIs</h5>
        </div>
        <div class="card-body">
          <% if @oauth_client.errors.any? %>
            <div class="alert alert-danger" role="alert"><%= t('doorkeeper.applications.form.error') %></div>
          <% end %>
          <p class="text-secondary small mb-2">Add one or more callback URLs for authorization. For non-redirect flows (e.g., client credentials, device code) this may be optional.</p>
          <div class="mb-3 row">
            <div class="col-sm-12">
              <%= render partial: 'layouts/components/form_elements/textarray',
                         locals: { form: f, values: @oauth_client.redirect_uris,
                                   field_type: "url", field_name: "oauth_client[redirect_uris]", add_button_text: "Add URI" } %>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <%= f.submit t('doorkeeper.applications.buttons.submit'), class: 'btn btn-primary' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="col-12">
    <%= form_for @oauth_client, url: developer_oauth_client_path(@oauth_client), as: :oauth_client, html: { role: 'form' } do |f| %>
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
          <i class="bi bi-sliders me-2"></i>
          <h5 class="mb-0">Client Settings</h5>
        </div>
        <div class="card-body">
          <% if @oauth_client.errors.any? %>
            <div class="alert alert-danger" role="alert"><%= t('doorkeeper.applications.form.error') %></div>
          <% end %>

          <%= render 'client_settings', f: f %>

          <div class="d-flex justify-content-end mt-3">
            <%= link_to t('doorkeeper.applications.buttons.cancel'), developer_application_path(@application), class: 'btn btn-outline-secondary me-2' %>
            <%= f.submit t('doorkeeper.applications.buttons.submit'), class: 'btn btn-primary' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
